<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bed Management System</title>
  <style>
    :root {
      --primary: #6a9ac4;      /* Calm Blue */
      --accent: #9ed5cb;       /* Mint Green */
      --highlight: #b8a4d4;    /* Soft Purple */
      --bg-light: #f0f6f6;     /* Light soothing background */
      --card-bg: #ffffff;
      --text-dark: #333;
      --text-muted: #555;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #F44336;
      --info: #2196F3;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-light);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: var(--card-bg);
      min-height: 100vh;
      padding: 20px;
      box-shadow: 0 0 20px rgba(106, 154, 196, 0.1);
    }

    h1 {
      text-align: center;
      color: var(--primary);
      background: linear-gradient(45deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.8em;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100vh;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 1.5em;
    }

    .sidebar-nav {
      padding: 0;
      list-style: none;
      margin: 0;
    }

    .sidebar-nav li {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-nav a {
      display: block;
      padding: 15px 20px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .sidebar-nav a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-nav a.active {
      background-color: rgba(255, 255, 255, 0.2);
      border-left: 4px solid white;
    }

    .sidebar-nav a i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .menu-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1001;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(106, 154, 196, 0.3);
      transition: all 0.3s ease;
    }

    .menu-btn:hover {
      background: var(--accent);
      transform: translateY(-2px);
    }

    .menu-btn.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }

    .overlay.show {
      display: block;
    }

    .main-content {
      transition: margin-left 0.3s ease;
    }

    .main-content.shifted {
      margin-left: 250px;
    }

    /* Ward Selection */
    .ward-selector {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 8px 25px rgba(106, 154, 196, 0.2);
    }

    .ward-selector h2 {
      color: white;
      margin: 0 0 15px 0;
      font-size: 1.5em;
    }

    .ward-dropdown {
      width: 100%;
      max-width: 300px;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      color: var(--text-dark);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .ward-dropdown:focus {
      outline: none;
      box-shadow: 0 6px 20px rgba(106, 154, 196, 0.3);
      transform: translateY(-2px);
    }

    /* Statistics Cards */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.3s ease;
      border-left: 5px solid;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.12);
    }

    .stat-card.total { border-left-color: var(--info); }
    .stat-card.available { border-left-color: var(--success); }
    .stat-card.occupied { border-left-color: var(--warning); }
    .stat-card.maintenance { border-left-color: var(--danger); }

    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .stat-card.total .stat-number { color: var(--info); }
    .stat-card.available .stat-number { color: var(--success); }
    .stat-card.occupied .stat-number { color: var(--warning); }
    .stat-card.maintenance .stat-number { color: var(--danger); }

    .stat-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Bed Visualization */
    .beds-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .beds-section h2 {
      color: var(--primary);
      margin-bottom: 25px;
      font-size: 1.8em;
    }

    .beds-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .bed-item {
      position: relative;
      aspect-ratio: 1.5/1;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .bed-item:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .bed-item.available {
      background: linear-gradient(135deg, var(--success), #66BB6A);
    }

    .bed-item.occupied {
      background: linear-gradient(135deg, var(--warning), #FFB74D);
    }

    .bed-item.maintenance {
      background: linear-gradient(135deg, var(--danger), #EF5350);
    }

    .bed-number {
      font-size: 1.2em;
      margin-bottom: 5px;
    }

    .bed-status {
      font-size: 0.8em;
      opacity: 0.9;
    }

    .patient-name {
      font-size: 0.7em;
      margin-top: 5px;
      opacity: 0.8;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal h3 {
      color: var(--primary);
      margin-bottom: 25px;
      font-size: 1.8em;
      text-align: center;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px 16px;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(106, 154, 196, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(106, 154, 196, 0.3);
    }

    .btn-secondary {
      background: #E0E0E0;
      color: var(--text-dark);
    }

    .btn-secondary:hover {
      background: #BDBDBD;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #EF5350);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
    }

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .legend-color.available { background: var(--success); }
    .legend-color.occupied { background: var(--warning); }
    .legend-color.maintenance { background: var(--danger); }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-section {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .beds-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- Menu Button -->
  <button class="menu-btn" id="menu-btn">‚ò∞</button>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>üè• Hospital System</h2>
    </div>
    <ul class="sidebar-nav">
      <li><a href="index.html"><i>üè†</i> Dashboard</a></li>
      <li><a href="beds.html" class="active"><i>üõèÔ∏è</i> Bed Management</a></li>
      <li><a href="patients.html"><i>üë•</i> Patient Management</a></li>
      <li><a href="staff.html"><i>üë®‚Äç‚öïÔ∏è</i> Staff Management</a></li>
      <li><a href="inventory.html"><i>üíä</i> Inventory Management</a></li>
      <li><a href="hospital.html"><i>üè•</i> Hospital Info</a></li>
      <li><a href="drugCheck.html"><i>üíä</i> Drug Checker</a></li>
    </ul>
  </nav>

  <!-- Overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
  <div class="container">
    <h1>üõèÔ∏è Bed Management System</h1>
    
    <!-- Hospital Selection -->
    <div class="ward-selector">
      <h2>üè• Select Hospital</h2>
      <select class="ward-dropdown" id="hospital-select">
        <option value="">Loading hospitals...</option>
      </select>
    </div>
    
    <!-- Ward Selection -->
    <div class="ward-selector">
      <h2>üìç Select Department</h2>
      <select class="ward-dropdown" id="ward-select">
        <option value="">Loading departments...</option>
      </select>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
      <div class="stat-card total">
        <div class="stat-number" id="total-beds">0</div>
        <div class="stat-label">Total Beds</div>
      </div>
      <div class="stat-card available">
        <div class="stat-number" id="available-beds">0</div>
        <div class="stat-label">Available</div>
      </div>
      <div class="stat-card occupied">
        <div class="stat-number" id="occupied-beds">0</div>
        <div class="stat-label">Occupied</div>
      </div>
      <div class="stat-card maintenance">
        <div class="stat-number" id="maintenance-beds">0</div>
        <div class="stat-label">Maintenance</div>
      </div>
    </div>

    <!-- Bed Visualization -->
    <div class="beds-section">
      <h2>üõèÔ∏è <span id="current-ward-name">Emergency Ward</span> Layout</h2>
      
      <!-- Legend -->
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color available"></div>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <div class="legend-color occupied"></div>
          <span>Occupied</span>
        </div>
        <div class="legend-item">
          <div class="legend-color maintenance"></div>
          <span>Maintenance</span>
        </div>
        <button class="btn btn-primary" id="add-bed-btn" style="margin-left: auto;">+ Add New Bed</button>
      </div>

      <div class="beds-grid" id="beds-grid">
        <!-- Beds will be dynamically generated here -->
      </div>
    </div>

    <!-- Modal for Bed Management -->
    <div class="modal" id="bed-modal">
      <div class="modal-content">
        <h3 id="modal-title">Bed Information</h3>
        <form id="bed-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="bed-number">Bed Number:</label>
              <input type="text" id="bed-number" readonly>
            </div>
            <div class="form-group">
              <label for="bed-status">Status:</label>
              <select id="bed-status">
                <option value="available">Available</option>
                <option value="occupied">Occupied</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
            <div class="form-group">
              <label for="room-number">Room Number:</label>
              <input type="text" id="room-number">
            </div>
            <div class="form-group">
              <label for="bed-type">Bed Type:</label>
              <select id="bed-type">
                <option value="standard">Standard</option>
                <option value="monitor">Monitor Bed</option>
                <option value="isolation">Isolation</option>
                <option value="intensive">Intensive Care</option>
              </select>
            </div>
            <div class="form-group full-width" id="patient-section">
              <label for="patient-name">Assigned Patient:</label>
              <input type="text" id="patient-name" placeholder="Enter patient name or ID">
            </div>
            <div class="form-group full-width">
              <label for="notes">Notes:</label>
              <textarea id="notes" rows="3" placeholder="Additional notes or comments"></textarea>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="discharge-btn" style="display: none;">Discharge Patient</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Configuration
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentHospitalId = null;
    let currentDepartment = 'emergency';
    let selectedBed = null;
    let bedsData = [];

    // Sidebar functionality
    const menuBtn = document.getElementById('menu-btn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const mainContent = document.getElementById('main-content');

    menuBtn.addEventListener('click', function() {
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
      mainContent.classList.toggle('shifted');
      menuBtn.classList.toggle('hidden');
    });

    overlay.addEventListener('click', function() {
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
      mainContent.classList.remove('shifted');
      menuBtn.classList.remove('hidden');
    });

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Bed Management page loaded');
      
      // Event listeners
      document.getElementById('hospital-select').addEventListener('change', handleHospitalChange);
      document.getElementById('ward-select').addEventListener('change', handleDepartmentChange);
      document.getElementById('bed-form').addEventListener('submit', handleBedUpdate);
      document.getElementById('cancel-btn').addEventListener('click', closeBedModal);
      document.getElementById('discharge-btn').addEventListener('click', handleDischarge);
      document.getElementById('add-bed-btn').addEventListener('click', openNewBedModal);
      
      // Initialize
      initializePage();
    });

    async function initializePage() {
      try {
        // Load hospitals and populate dropdown
        const hospitals = await fetchHospitals();
        populateHospitalDropdown(hospitals);
        
        if (hospitals.length > 0) {
          currentHospitalId = hospitals[0]._id;
          
          // Load departments for the first hospital
          const departments = await fetchDepartments(currentHospitalId);
          await populateDepartmentDropdown(departments);
          
          // Load beds and stats
          await loadBeds();
          await updateStats();
        } else {
          showNotification('No hospitals found. Please create a hospital first.', 'error');
        }
      } catch (error) {
        console.error('Error initializing page:', error);
        showNotification('Error loading hospital data', 'error');
      }
    }

    function populateHospitalDropdown(hospitals) {
      const hospitalSelect = document.getElementById('hospital-select');
      hospitalSelect.innerHTML = '';
      
      if (hospitals.length === 0) {
        hospitalSelect.innerHTML = '<option value="">No hospitals available</option>';
        return;
      }
      
      hospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital._id;
        option.textContent = hospital.name;
        hospitalSelect.appendChild(option);
      });
      
      // Set the first hospital as selected
      if (hospitals.length > 0) {
        hospitalSelect.value = hospitals[0]._id;
      }
    }

    async function populateDepartmentDropdown(departments) {
      const wardSelect = document.getElementById('ward-select');
      wardSelect.innerHTML = '';
      
      if (departments.length === 0) {
        wardSelect.innerHTML = '<option value="all">All Departments</option>';
        currentDepartment = 'all';
        updateDepartmentName();
        return;
      }
      
      // Add "All Departments" option first
      const allOption = document.createElement('option');
      allOption.value = 'all';
      allOption.textContent = 'üè• All Departments';
      wardSelect.appendChild(allOption);
      
      // Add department-specific options
      departments.forEach(department => {
        const option = document.createElement('option');
        option.value = department;
        option.textContent = getDepartmentDisplayName(department);
        wardSelect.appendChild(option);
      });
      
      // Set the first available department as selected, or "all" if none
      if (departments.length > 0) {
        wardSelect.value = departments[0];
        currentDepartment = departments[0];
      } else {
        wardSelect.value = 'all';
        currentDepartment = 'all';
      }
      updateDepartmentName();
    }

    function getDepartmentDisplayName(department) {
      const departmentIcons = {
        emergency: 'üö® Emergency',
        general: 'üè• General',
        icu: 'ü©∫ ICU',
        cardiology: '‚ù§Ô∏è Cardiology',
        pediatrics: 'üë∂ Pediatrics',
        surgery: 'üî™ Surgery',
        orthopedics: 'ü¶¥ Orthopedics',
        neurology: 'üß† Neurology',
        oncology: 'üéóÔ∏è Oncology',
        maternity: 'üë∂ Maternity',
        psychiatry: 'üßò Psychiatry',
        radiology: 'üì° Radiology'
      };
      
      return departmentIcons[department.toLowerCase()] || `üè• ${department.charAt(0).toUpperCase() + department.slice(1)}`;
    }

    async function handleHospitalChange(e) {
      currentHospitalId = e.target.value;
      if (currentHospitalId) {
        // Load departments for the selected hospital
        const departments = await fetchDepartments(currentHospitalId);
        await populateDepartmentDropdown(departments);
        
        // Load beds for the hospital/department
        await loadBeds();
        await updateStats();
      }
    }

    async function fetchHospitals() {
      try {
        const response = await fetch(`${API_BASE_URL}/hospitals`);
        const data = await response.json();
        if (data.success) {
          return data.data;
        } else {
          throw new Error(data.error || 'Failed to fetch hospitals');
        }
      } catch (error) {
        console.error('Error fetching hospitals:', error);
        return [];
      }
    }

    async function fetchDepartments(hospitalId) {
      if (!hospitalId) return [];
      
      try {
        const response = await fetch(`${API_BASE_URL}/hospitals/${hospitalId}/departments`);
        const data = await response.json();
        if (data.success) {
          return data.data;
        } else {
          throw new Error(data.error || 'Failed to fetch departments');
        }
      } catch (error) {
        console.error('Error fetching departments:', error);
        return [];
      }
    }

    async function fetchBeds() {
      if (!currentHospitalId) return [];
      
      try {
        let url;
        if (currentDepartment && currentDepartment !== 'all') {
          url = `${API_BASE_URL}/hospitals/${currentHospitalId}/beds/department/${currentDepartment}`;
        } else {
          url = `${API_BASE_URL}/hospitals/${currentHospitalId}/beds`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        if (data.success) {
          return data.data;
        } else {
          throw new Error(data.error || 'Failed to fetch beds');
        }
      } catch (error) {
        console.error('Error fetching beds:', error);
        showNotification('Error loading beds data', 'error');
        return [];
      }
    }

    async function fetchBedStats() {
      if (!currentHospitalId) return { total_beds: 0, available_beds: 0, occupied_beds: 0, maintenance_beds: 0 };
      
      try {
        const response = await fetch(`${API_BASE_URL}/hospitals/${currentHospitalId}/beds/stats`);
        const data = await response.json();
        if (data.success) {
          return data.data;
        } else {
          throw new Error(data.error || 'Failed to fetch bed statistics');
        }
      } catch (error) {
        console.error('Error fetching bed stats:', error);
        return { total_beds: 0, available_beds: 0, occupied_beds: 0, maintenance_beds: 0 };
      }
    }

    function handleDepartmentChange(e) {
      currentDepartment = e.target.value;
      updateDepartmentName();
      loadBeds();
      updateStats();
    }

    function updateDepartmentName() {
      if (currentDepartment === 'all') {
        document.getElementById('current-ward-name').textContent = 'All Departments';
      } else {
        const departmentNames = {
          emergency: 'Emergency Ward',
          general: 'General Ward',
          icu: 'Intensive Care Unit',
          cardiology: 'Cardiology Department',
          pediatrics: 'Pediatrics Department',
          surgery: 'Surgery Department',
          orthopedics: 'Orthopedics Department',
          neurology: 'Neurology Department',
          oncology: 'Oncology Department',
          maternity: 'Maternity Ward',
          psychiatry: 'Psychiatry Department',
          radiology: 'Radiology Department'
        };
        
        const displayName = departmentNames[currentDepartment] || 
                          `${currentDepartment.charAt(0).toUpperCase() + currentDepartment.slice(1)} Department`;
        document.getElementById('current-ward-name').textContent = displayName;
      }
    }

    async function loadBeds() {
      bedsData = await fetchBeds();
      displayBeds();
    }

    function displayBeds() {
      const bedsGrid = document.getElementById('beds-grid');
      bedsGrid.innerHTML = '';
      
      if (bedsData.length === 0) {
        bedsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">No beds found for this department. Create some beds to get started.</p>';
        return;
      }
      
      bedsData.forEach(bed => {
        const bedElement = createBedElement(bed);
        bedsGrid.appendChild(bedElement);
      });
    }

    function createBedElement(bed) {
      const bedDiv = document.createElement('div');
      bedDiv.className = `bed-item ${bed.status}`;
      bedDiv.onclick = () => openBedModal(bed);
      
      let content = `
        <div class="bed-number">${bed.bed_number}</div>
        <div class="bed-status">${bed.status.charAt(0).toUpperCase() + bed.status.slice(1)}</div>
      `;
      
      if (bed.patient_id && bed.status === 'occupied') {
        content += `<div class="patient-name">Patient: ${bed.patient_id}</div>`;
      }
      
      bedDiv.innerHTML = content;
      return bedDiv;
    }

    async function updateStats() {
      const stats = await fetchBedStats();
      
      if (currentDepartment === 'all') {
        // Show hospital-wide stats
        document.getElementById('total-beds').textContent = stats.total_beds;
        document.getElementById('available-beds').textContent = stats.available_beds;
        document.getElementById('occupied-beds').textContent = stats.occupied_beds;
        document.getElementById('maintenance-beds').textContent = stats.maintenance_beds;
      } else {
        // Show department-specific stats
        const departmentStats = stats.department_stats && stats.department_stats[currentDepartment];
        if (departmentStats) {
          document.getElementById('total-beds').textContent = departmentStats.total;
          document.getElementById('available-beds').textContent = departmentStats.available;
          document.getElementById('occupied-beds').textContent = departmentStats.occupied;
          document.getElementById('maintenance-beds').textContent = departmentStats.total - departmentStats.available - departmentStats.occupied;
        } else {
          // Fallback to counting current department beds
          const departmentBeds = bedsData;
          const departmentCounts = {
            total: departmentBeds.length,
            available: departmentBeds.filter(b => b.status === 'available').length,
            occupied: departmentBeds.filter(b => b.status === 'occupied').length,
            maintenance: departmentBeds.filter(b => b.status === 'maintenance').length
          };
          
          document.getElementById('total-beds').textContent = departmentCounts.total;
          document.getElementById('available-beds').textContent = departmentCounts.available;
          document.getElementById('occupied-beds').textContent = departmentCounts.occupied;
          document.getElementById('maintenance-beds').textContent = departmentCounts.maintenance;
        }
      }
    }

    function openBedModal(bed) {
      selectedBed = bed;
      const modal = document.getElementById('bed-modal');
      
      // Populate form
      document.getElementById('bed-number').value = bed.bed_number;
      document.getElementById('bed-status').value = bed.status;
      document.getElementById('room-number').value = bed.room_number;
      document.getElementById('bed-type').value = bed.bed_type;
      document.getElementById('patient-name').value = bed.patient_id || '';
      document.getElementById('notes').value = bed.notes || '';
      
      // Make bed number readonly for existing beds
      document.getElementById('bed-number').readOnly = true;
      
      // Show/hide discharge button
      const dischargeBtn = document.getElementById('discharge-btn');
      if (bed.status === 'occupied' && bed.patient_id) {
        dischargeBtn.style.display = 'inline-block';
      } else {
        dischargeBtn.style.display = 'none';
      }
      
      // Update modal title
      document.getElementById('modal-title').textContent = `Bed ${bed.bed_number} - Room ${bed.room_number}`;
      
      // Show patient section only if bed can have patients
      const patientSection = document.getElementById('patient-section');
      if (bed.status === 'maintenance') {
        patientSection.style.display = 'none';
      } else {
        patientSection.style.display = 'block';
      }
      
      modal.style.display = 'block';
    }

    function openNewBedModal() {
      if (!currentHospitalId) {
        showNotification('Please select a hospital first', 'error');
        return;
      }
      
      if (!currentDepartment || currentDepartment === 'all') {
        showNotification('Please select a specific department to add a bed', 'error');
        return;
      }
      
      selectedBed = null; // This indicates we're creating a new bed
      const modal = document.getElementById('bed-modal');
      
      // Clear form
      document.getElementById('bed-number').value = '';
      document.getElementById('bed-status').value = 'available';
      document.getElementById('room-number').value = '';
      document.getElementById('bed-type').value = 'standard';
      document.getElementById('patient-name').value = '';
      document.getElementById('notes').value = '';
      
      // Make bed number editable for new beds
      document.getElementById('bed-number').readOnly = false;
      
      // Hide discharge button for new beds
      document.getElementById('discharge-btn').style.display = 'none';
      
      // Update modal title to show department
      document.getElementById('modal-title').textContent = `Add New Bed - ${getDepartmentDisplayName(currentDepartment)}`;
      
      // Show patient section
      const patientSection = document.getElementById('patient-section');
      patientSection.style.display = 'block';
      
      modal.style.display = 'block';
    }

    function closeBedModal() {
      document.getElementById('bed-modal').style.display = 'none';
      selectedBed = null;
    }

    async function handleBedUpdate(e) {
      e.preventDefault();
      
      // Get form values
      const bedNumber = document.getElementById('bed-number').value.trim();
      const newStatus = document.getElementById('bed-status').value;
      const newRoom = document.getElementById('room-number').value.trim();
      const newType = document.getElementById('bed-type').value;
      const newPatient = document.getElementById('patient-name').value.trim();
      const newNotes = document.getElementById('notes').value.trim();
      
      // Validation
      if (!bedNumber) {
        alert('Please enter a bed number.');
        return;
      }
      
      if (!newRoom) {
        alert('Please enter a room number.');
        return;
      }
      
      if (newStatus === 'occupied' && !newPatient) {
        alert('Please enter a patient ID for occupied beds.');
        return;
      }
      
      if (newStatus !== 'occupied' && newPatient) {
        alert('Cannot assign patient to non-occupied bed.');
        return;
      }
      
      try {
        if (selectedBed) {
          // Update existing bed
          const updateData = {
            bed_number: bedNumber,
            status: newStatus,
            room_number: newRoom,
            bed_type: newType,
            patient_id: newStatus === 'occupied' ? newPatient : null,
            notes: newNotes
          };
          
          const response = await fetch(`${API_BASE_URL}/beds/${selectedBed._id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
          });
          
          const data = await response.json();
          if (data.success) {
            showNotification(`Bed ${bedNumber} updated successfully!`, 'success');
          } else {
            throw new Error(data.error || 'Failed to update bed');
          }
        } else {
          // Create new bed
          const newBedData = {
            bed_number: bedNumber,
            room_number: newRoom,
            department: currentDepartment,
            bed_type: newType,
            status: newStatus,
            patient_id: newStatus === 'occupied' ? newPatient : null,
            floor: 1, // Default floor
            wing: 'Main', // Default wing
            notes: newNotes
          };
          
          const response = await fetch(`${API_BASE_URL}/hospitals/${currentHospitalId}/beds`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(newBedData)
          });
          
          const data = await response.json();
          if (data.success) {
            showNotification(`New bed ${bedNumber} created successfully!`, 'success');
          } else {
            throw new Error(data.error || 'Failed to create bed');
          }
        }
        
        // Refresh display
        await loadBeds();
        await updateStats();
        closeBedModal();
        
      } catch (error) {
        console.error('Error with bed operation:', error);
        showNotification('Error: ' + error.message, 'error');
      }
    }

    async function handleDischarge() {
      if (!selectedBed || selectedBed.status !== 'occupied') return;
      
      if (confirm(`Are you sure you want to discharge patient ${selectedBed.patient_id} from bed ${selectedBed.bed_number}?`)) {
        try {
          const updateData = {
            status: 'available',
            patient_id: null,
            notes: 'Recently discharged - ready for cleaning'
          };
          
          const response = await fetch(`${API_BASE_URL}/beds/${selectedBed._id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
          });
          
          const data = await response.json();
          if (data.success) {
            await loadBeds();
            await updateStats();
            closeBedModal();
            showNotification(`Patient discharged from bed ${selectedBed.bed_number}`, 'success');
          } else {
            throw new Error(data.error || 'Failed to discharge patient');
          }
        } catch (error) {
          console.error('Error discharging patient:', error);
          showNotification('Error discharging patient: ' + error.message, 'error');
        }
      }
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 3000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 400px;
      `;
      
      // Set colors based on type
      switch(type) {
        case 'success':
          notification.style.background = 'linear-gradient(135deg, #4CAF50, #66BB6A)';
          break;
        case 'error':
          notification.style.background = 'linear-gradient(135deg, #F44336, #EF5350)';
          break;
        default:
          notification.style.background = 'linear-gradient(135deg, #2196F3, #42A5F5)';
      }
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Remove after 4 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 4000);
    }

    // Status change handler for the form
    document.addEventListener('DOMContentLoaded', function() {
      const statusSelect = document.getElementById('bed-status');
      const patientSection = document.getElementById('patient-section');
      
      if (statusSelect && patientSection) {
        statusSelect.addEventListener('change', function() {
          if (this.value === 'maintenance') {
            patientSection.style.display = 'none';
            document.getElementById('patient-name').value = '';
          } else {
            patientSection.style.display = 'block';
          }
        });
      }
    });
  </script>
</body>
</html>
